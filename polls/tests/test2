from django.contrib.auth.models import User
from django.contrib.staticfiles.testing import StaticLiveServerTestCase
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.firefox.webdriver import WebDriver
from selenium.common.exceptions import NoSuchElementException
import time

class AdminPanelTest(StaticLiveServerTestCase):
    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        options = Options()
        options.headless = True  # Executa el test en mode headless (sense interfície)
        cls.selenium = WebDriver(options=options)
        cls.selenium.implicitly_wait(5)

        # Crea el superusuari per al test
        user = User.objects.create_user("isard", "isard@isardvdi.com", "pirineus")
        user.is_superuser = True
        user.is_staff = True
        user.save()

    @classmethod
    def tearDownClass(cls):
        cls.selenium.quit()
        super().tearDownClass()

    def test_create_questions_and_choices(self):
        # Inicia sessió com a superusuari
        self.selenium.get(f'{self.live_server_url}/admin/')
        username_input = self.selenium.find_element(By.NAME, "username")
        password_input = self.selenium.find_element(By.NAME, "password")
        username_input.send_keys("isard")
        password_input.send_keys("pirineus")
        self.selenium.find_element(By.XPATH, "//input[@type='submit']").click()

        # Comprova que s'ha iniciat sessió correctament
        self.selenium.find_element(By.LINK_TEXT, "Polls")

        # Entra a la secció de Questions i crea la primera Question
        self.selenium.find_element(By.LINK_TEXT, "Questions").click()
        self.selenium.find_element(By.LINK_TEXT, "Add question").click()
        question_text_input = self.selenium.find_element(By.NAME, "question_text")
        pub_date_input = self.selenium.find_element(By.NAME, "pub_date")
        question_text_input.send_keys("What's new?")
        pub_date_input.send_keys("2024-11-02 12:00:00")
        choice_text_1 = self.selenium.find_element(By.NAME, "choice_set-0-choice_text")
        choice_text_2 = self.selenium.find_element(By.NAME, "choice_set-1-choice_text")
        choice_text_1.send_keys("Not much")
        choice_text_2.send_keys("The sky")
        self.selenium.find_element(By.NAME, "_save").click()

        # Crea la segona Question amb Choices
        self.selenium.find_element(By.LINK_TEXT, "Add question").click()
        question_text_input = self.selenium.find_element(By.NAME, "question_text")
        pub_date_input = self.selenium.find_element(By.NAME, "pub_date")
        question_text_input.send_keys("What's up?")
        pub_date_input.send_keys("2024-11-02 12:00:00")
        choice_text_1 = self.selenium.find_element(By.NAME, "choice_set-0-choice_text")
        choice_text_2 = self.selenium.find_element(By.NAME, "choice_set-1-choice_text")
        choice_text_1.send_keys("Just chilling")
        choice_text_2.send_keys("Reading a book")
        self.selenium.find_element(By.NAME, "_save").click()

        # Comprova que les Choices s'han creat correctament
        self.selenium.find_element(By.LINK_TEXT, "Questions").click()
        self.selenium.find_element(By.LINK_TEXT, "What's new?").click()
        choice_elements = self.selenium.find_elements(By.CLASS_NAME, "field-choice_text")
        assert len(choice_elements) == 2
        assert "Not much" in [choice.text for choice in choice_elements]
        assert "The sky" in [choice.text for choice in choice_elements]

        # Verifica les Choices de la segona Question
        self.selenium.find_element(By.LINK_TEXT, "Questions").click()
        self.selenium.find_element(By.LINK_TEXT, "What's up?").click()
        choice_elements = self.selenium.find_elements(By.CLASS_NAME, "field-choice_text")
        assert len(choice_elements) == 2
        assert "Just chilling" in [choice.text for choice in choice_elements]
        assert "Reading a book" in [choice.text for choice in choice_elements]
